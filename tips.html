<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Front de Mer - Tips Map</title>

<link href='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css' rel='stylesheet' />

<style>
body { margin:0; font-family:Arial,sans-serif; color:#333; }
header { background:#2E8B57; color:white; padding:1rem; text-align:center; }
.lang-btn { margin:0 0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.lang-btn:hover { background:#fff; color:#2E8B57; }
#map { width:100%; height:500px; }
ul { list-style-type: disc; margin:1rem 2rem; }
li { cursor:pointer; margin:0.5rem 0; }
</style>
</head>
<body>

<header>
  <h1>Front de Mer - Tips & Activiteiten</h1>
  <button class="lang-btn" onclick="showLang('nl')">NL</button>
  <button class="lang-btn" onclick="showLang('fr')">FR</button>
  <button class="lang-btn" onclick="showLang('en')">EN</button>
</header>

<div id="map"></div>

<h2>Locaties</h2>
<ul id="tips-list"></ul>

<script src='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js'></script>
<!-- N3.js voor RDF/Turtle parsing -->
<script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>

<script>
// Mapbox token
mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmF3YWFnIiwiYSI6ImNtaWFkcjRxMTBiaTAya3FwcjJodzl1bDIifQ.Eb3w10-AlZPCvvcn5R8QJA';

// Maak de kaart
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [3.164, 42.440],
    zoom: 13
});

map.markers = [];
let currentLang = 'nl';  // nog niet echt gebruikt voor labels, maar kan later

// Namespaces
const GEO = 'http://www.opengis.net/ont/geosparql#';
const OSM_KEY = 'https://www.openstreetmap.org/wiki/Key:';
const OSM_ADDR = 'https://www.openstreetmap.org/wiki/Key:addr:';

// RDF laden i.p.v. JSON
async function loadRdf() {
  try {
    const resp = await fetch('osm.ttl');
    const ttl = await resp.text();

    const parser = new N3.Parser();
    const store = new N3.Store();
    store.addQuads(parser.parse(ttl));

    const features = extractFeaturesFromStore(store);
    renderFeatures(features);
  } catch(e){
    console.error("Kon RDF niet laden/parsen:", e);
  }
}

// RDF → interne feature-structuur
function extractFeaturesFromStore(store) {
  const features = [];

  // alle ?node geo:hasGeometry ?geom
  const quadsHasGeom = store.getQuads(null, GEO + 'hasGeometry', null, null);

  for (const q of quadsHasGeom) {
    const subject = q.subject;  // OSM node
    const geom = q.object;      // geometry-node

    // zoek geo:asWKT
    const wktQuad = store.getQuads(geom, GEO + 'asWKT', null, null)[0];
    if (!wktQuad) continue;

    const wktLiteral = wktQuad.object.value; // "POINT(3.165895 42.440632)"
    const coords = parseWKTPoint(wktLiteral);
    if (!coords) continue;
    const [lon, lat] = coords;

    // extra info
    const nameQuad = store.getQuads(subject, OSM_KEY + 'name', null, null)[0];
    const tourismQuad = store.getQuads(subject, OSM_KEY + 'tourism', null, null)[0];
    const streetQuad = store.getQuads(subject, OSM_ADDR + 'street', null, null)[0];
    const housenrQuad = store.getQuads(subject, OSM_ADDR + 'housenumber', null, null)[0];

    const name = nameQuad ? nameQuad.object.value : null;
    const tourism = tourismQuad ? tourismQuad.object.value : null;
    const street = streetQuad ? streetQuad.object.value : null;
    const housenr = housenrQuad ? housenrQuad.object.value : null;

    let label = name || subject.value || subject.id;
    if (!name && street && housenr) {
      label = `${street} ${housenr}`;
    }

    let type = 'poi';
    if (tourism === 'hotel') type = 'hotel';

    features.push({
      uri: subject.value || subject.id,
      lon,
      lat,
      label,
      type,
      street,
      housenr
    });
  }

  return features;
}

// heel simpele WKT-parser voor POINT(lon lat)
function parseWKTPoint(wkt) {
  const match = /POINT\s*\(\s*([0-9.\-+]+)\s+([0-9.\-+]+)\s*\)/i.exec(wkt);
  if (!match) return null;
  const lon = parseFloat(match[1]);
  const lat = parseFloat(match[2]);
  return [lon, lat];
}

// Features tekenen
function renderFeatures(features){
  const list = document.getElementById('tips-list');
  list.innerHTML = '';

  // Oude markers verwijderen
  map.markers.forEach(m => m.remove());
  map.markers = [];

  features.forEach(item => {
    const marker = new mapboxgl.Marker({color:getMarkerColor(item.type)})
      .setLngLat([item.lon, item.lat])
      .setPopup(new mapboxgl.Popup({offset:25}).setText(item.label))
      .addTo(map);
    map.markers.push(marker);

    const li = document.createElement('li');
    li.textContent = `${item.label} (${item.type})`;
    li.dataset.lat = item.lat;
    li.dataset.lon = item.lon;
    li.addEventListener('click', () => {
      map.flyTo({center:[item.lon, item.lat], zoom:15});
      marker.togglePopup();
    });
    list.appendChild(li);
  });
}

function getMarkerColor(type){
  switch(type){
    case 'hotel': return 'purple';
    default: return 'blue';
  }
}

// Taal wisselen – voor nu alleen state; later kun je hier bv. RDF met taal-tags gebruiken
function showLang(lang){
  currentLang = lang;
  console.log("Language switched to:", lang);
  // als je straks labels per taal in RDF zet, kun je hier opnieuw renderen
}

// Start
loadRdf();
</script>

</body>
</html>
