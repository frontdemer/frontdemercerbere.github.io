<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Front de Mer - Tips Map</title>

<link href='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css' rel='stylesheet' />

<style>
body { margin:0; font-family:Arial,sans-serif; color:#333; }
header { background:#2E8B57; color:white; padding:1rem; text-align:center; }
.lang-btn { margin:0 0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.lang-btn:hover { background:#fff; color:#2E8B57; }
#map { width:100%; height:500px; }
h3 { margin-left:2rem; margin-top:1.5rem; }
ul { list-style-type: disc; margin:0.5rem 3rem; padding-left:1rem; }
li { cursor:pointer; margin:0.5rem 0; }
</style>
</head>
<body>

<header>
  <h1>Front de Mer - Tips & Activiteiten</h1>
  <button class="lang-btn" onclick="showLang('nl')">NL</button>
  <button class="lang-btn" onclick="showLang('fr')">FR</button>
  <button class="lang-btn" onclick="showLang('en')">EN</button>
</header>

<div id="map"></div>

<h2>Locaties</h2>
<div id="tips-list"></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js'></script>
<script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>

<script>
// Mapbox token
mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmF3YWFnIiwiYSI6ImNtaWFkcjRxMTBiaTAya3FwcjJodzl1bDIifQ.Eb3w10-AlZPCvvcn5R8QJA';

// Map
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [3.164, 42.440],
    zoom: 13
});

map.markers = [];
let currentLang = 'nl';

// Namespaces
const GEO = 'http://www.opengis.net/ont/geosparql#';
const OSM_KEY = 'https://www.openstreetmap.org/wiki/Key:';
const OSM_ADDR = 'https://www.openstreetmap.org/wiki/Key:addr:';

// Type labels for headings
const typeLabels = {
  poi: { nl: "Bezienswaardigheden", fr: "Points d'intérêt", en: "Points of Interest" },
  hotel: { nl: "Hotels", fr: "Hôtels", en: "Hotels" },
  museum: { nl: "Musea", fr: "Musées", en: "Museums" }
};

function getTypeLabel(type){
  return typeLabels[type]?.[currentLang] || typeLabels[type]?.en || type;
}

// Load RDF
async function loadRdf() {
  try {
    const resp = await fetch('osm.ttl');
    const ttl = await resp.text();

    const parser = new N3.Parser();
    const store = new N3.Store();
    store.addQuads(parser.parse(ttl));

    const features = extractFeaturesFromStore(store);
    const featuresByType = clusterFeaturesByType(features);
    renderFeatures(featuresByType);
  } catch(e){
    console.error("Kon RDF niet laden/parsen:", e);
  }
}

// Extract features from RDF store
function extractFeaturesFromStore(store) {
  const features = [];
  const quadsHasGeom = store.getQuads(null, GEO + 'hasGeometry', null, null);

  for (const q of quadsHasGeom) {
    const subject = q.subject;
    const geom = q.object;

    const wktQuad = store.getQuads(geom, GEO + 'asWKT', null, null)[0];
    if (!wktQuad) continue;
    const coords = parseWKTPoint(wktQuad.object.value);
    if (!coords) continue;
    const [lon, lat] = coords;

    const nameQuads = store.getQuads(subject, OSM_KEY + 'name', null, null);
    const labels = {};
    nameQuads.forEach(nq => {
      const lang = nq.object.language || 'default';
      labels[lang] = nq.object.value;
    });

    const tourismQuad = store.getQuads(subject, OSM_KEY + 'tourism', null, null)[0];
    const type = tourismQuad ? (tourismQuad.object.value === 'hotel' ? 'hotel' : (tourismQuad.object.value === 'museum' ? 'museum' : 'poi')) : 'poi';

    features.push({
      uri: subject.value || subject.id,
      lon, lat,
      labels,
      type
    });
  }
  return features;
}

// Cluster features by type
function clusterFeaturesByType(features){
  const clustered = {};
  features.forEach(f => {
    if(!clustered[f.type]) clustered[f.type] = [];
    clustered[f.type].push(f);
  });
  return clustered;
}

// Simple WKT POINT parser
function parseWKTPoint(wkt){
  const match = /POINT\s*\(\s*([0-9.\-+]+)\s+([0-9.\-+]+)\s*\)/i.exec(wkt);
  if(!match) return null;
  return [parseFloat(match[1]), parseFloat(match[2])];
}

// Render features grouped by type
function renderFeatures(featuresByType){
  const list = document.getElementById('tips-list');
  list.innerHTML = '';

  map.markers.forEach(m => m.remove());
  map.markers = [];

  Object.keys(featuresByType).forEach(type => {
    const heading = document.createElement('h3');
    heading.textContent = getTypeLabel(type);
    list.appendChild(heading);

    const ul = document.createElement('ul');

    featuresByType[type].forEach(item => {
      const label = item.labels[currentLang] || item.labels['en'] || item.labels['default'];

      const marker = new mapboxgl.Marker({ color: getMarkerColor(type) })
        .setLngLat([item.lon, item.lat])
        .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(label))
        .addTo(map);
      map.markers.push(marker);

      const li = document.createElement('li');
      li.textContent = label;
      li.addEventListener('click', () => {
        map.flyTo({ center: [item.lon, item.lat], zoom: 15 });
        marker.togglePopup();
      });
      ul.appendChild(li);
    });

    list.appendChild(ul);
  });
}

function getMarkerColor(type){
  switch(type){
    case 'hotel': return 'purple';
    case 'museum': return 'orange';
    default: return 'blue';
  }
}

function showLang(lang){
  currentLang = lang;
  loadRdf();
}

// Start
loadRdf();
</script>

</body>
</html>
