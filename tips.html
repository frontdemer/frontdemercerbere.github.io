<!DOCTYPE html>
<html>
<head>
  <title>OSM RDF Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/rdflib/dist/rdflib.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div id="map" style="width:100%; height:600px;"></div>
<script>
const store = $rdf.graph();
const GEO = 'http://www.opengis.net/ont/geosparql#';
const OSM_KEY = 'http://example.org/osm#';
const ns5 = 'http://example.org/ns5#';

// Initialize map
const map = L.map('map').setView([41.98, 2.96], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function parseWKTGeom(wkt){
  if(!wkt) return null;

  if(wkt.startsWith('POINT')){
    const match = /POINT\s*\(\s*([0-9.\-+]+)\s+([0-9.\-+]+)\s*\)/i.exec(wkt);
    return match ? [parseFloat(match[2]), parseFloat(match[1])] : null; // Leaflet: lat,lng
  }
  else if(wkt.startsWith('LINESTRING') || wkt.startsWith('POLYGON')){
    const nums = wkt.match(/-?\d+\.?\d*/g).map(Number);
    const coords = [];
    for(let i=0;i<nums.length;i+=2) coords.push([nums[i+1], nums[i]]); // Leaflet: lat,lng
    const lat = coords.reduce((sum,c)=>sum+c[0],0)/coords.length;
    const lng = coords.reduce((sum,c)=>sum+c[1],0)/coords.length;
    return [lat,lng]; // centroid
  }
  return null;
}

function extractFeaturesFromStore(store){
  const features = [];
  const subjects = store.subjects(null, null, null);

  subjects.forEach(subject => {
    const geomQuad = store.any(subject, $rdf.sym(GEO+'hasGeometry'));
    if(!geomQuad) return;

    const wktQuad = store.any(geomQuad, $rdf.sym(GEO+'asWKT'));
    if(!wktQuad) return;

    const coords = parseWKTGeom(wktQuad.value);
    if(!coords) return;

    // Detect type
    let type = 'poi';
    const tourism = store.any(subject, $rdf.sym(OSM_KEY+'tourism'));
    const leisure = store.any(subject, $rdf.sym(ns5+'leisure'));
    const sport = store.any(subject, $rdf.sym(ns5+'sport'));

    if(tourism) type = tourism.value;
    else if(leisure) type = leisure.value;
    else if(sport) type = sport.value;

    // Name
    const nameQuad = store.any(subject, $rdf.sym(ns5+'name'));
    const name = nameQuad ? nameQuad.value : 'unknown';

    features.push({coords, type, name});
  });

  return features;
}

// Example RDF data
const data = `
@prefix ns1: <http://example.org/ns1#> .
@prefix ns3: <http://example.org/ns3#> .
@prefix ns4: <http://example.org/ns4#> .
@prefix ns5: <http://example.org/ns5#> .
@prefix ns6: <http://example.org/ns6#> .
@prefix geo: <http://www.opengis.net/ont/geosparql#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

ns1:848853711 a <https://www.openstreetmap.org/way> ;
    geo:hasGeometry [ geo:asWKT "POLYGON((2.9630 41.9820,2.9640 41.9820,2.9640 41.9830,2.9630 41.9830,2.9630 41.9820))" ] ;
    ns5:leisure "sports_centre" ;
    ns5:sport "karting" ;
    ns5:name "Karting Roses" .
`;

// Load RDF and render
$rdf.parse(data, store, 'http://example.org/', 'text/turtle', () => {
  const features = extractFeaturesFromStore(store);

  features.forEach(f => {
    L.marker(f.coords)
      .addTo(map)
      .bindPopup(`<b>${f.name}</b><br>Type: ${f.type}`);
  });
});
</script>
</body>
</html>
