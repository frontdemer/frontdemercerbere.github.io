<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Front de Mer - Tips Map</title>

<link href='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css' rel='stylesheet' />

<style>
body { margin:0; font-family:Arial,sans-serif; color:#333; }
header { background:#2E8B57; color:white; padding:1rem; text-align:center; }
.lang-btn { margin:0 0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.lang-btn:hover { background:#fff; color:#2E8B57; }
#map { width:100%; height:500px; }
ul { list-style-type:none; margin:1rem 2rem; padding:0; }
li { cursor:pointer; margin:0.5rem 0; }
.type-heading { font-weight:bold; margin-top:1rem; }
</style>
</head>
<body>

<header>
  <h1>Front de Mer - Tips & Activities</h1>
  <button class="lang-btn" onclick="showLang('en')">EN</button>
</header>

<div id="map"></div>

<h2>Locations</h2>
<div id="tips-list"></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js'></script>
<script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>

<script>
// Mapbox token
mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmF3YWFnIiwiYSI6ImNtaWFkcjRxMTBiaTAya3FwcjJodzl1bDIifQ.Eb3w10-AlZPCvvcn5R8QJA';

// Create map
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [3.164, 42.440],
    zoom: 13
});

map.markers = [];
let currentLang = 'en';

// Namespaces
const GEO = 'http://www.opengis.net/ont/geosparql#';
const OSM_KEY = 'https://www.openstreetmap.org/wiki/Key:';
const OSM_ADDR = 'https://www.openstreetmap.org/wiki/Key:addr:';

// Load RDF from file
async function loadRdf() {
  try {
    const resp = await fetch('osm.ttl');
    const ttl = await resp.text();

    const parser = new N3.Parser();
    const store = new N3.Store();
    store.addQuads(parser.parse(ttl));

    const features = extractFeaturesFromStore(store);
    renderFeatures(features);
  } catch(e){
    console.error("Failed to load/parse RDF:", e);
  }
}

// Extract features from RDF store
function extractFeaturesFromStore(store) {
  const features = [];

  // Handle nodes
  const quadsHasGeom = store.getQuads(null, GEO + 'hasGeometry', null, null);
  for (const q of quadsHasGeom) {
    const subject = q.subject;
    const geom = q.object;

    const wktQuad = store.getQuads(geom, GEO + 'asWKT', null, null)[0];
    if (!wktQuad) continue;

    const coords = parseWKT(wktQuad.object.value);
    if (!coords) continue;

    // Extract common properties
    const name = firstValue(store.getQuads(subject, OSM_KEY + 'name', null, null));
    const tourism = firstValue(store.getQuads(subject, OSM_KEY + 'tourism', null, null));
    const leisure = firstValue(store.getQuads(subject, OSM_KEY + 'leisure', null, null));
    const street = firstValue(store.getQuads(subject, OSM_ADDR + 'street', null, null));
    const housenr = firstValue(store.getQuads(subject, OSM_ADDR + 'housenumber', null, null));

    let label = name || (street && housenr ? `${street} ${housenr}` : subject.value);
    let type = 'poi';
    if (tourism === 'museum') type = 'museum';
    else if (leisure === 'sports_centre') type = 'sports';
    else if (tourism === 'restaurant') type = 'restaurant';

    features.push({
      uri: subject.value,
      coords,
      label,
      type
    });
  }

  return features;
}

function firstValue(quads) {
  return quads.length ? quads[0].object.value : null;
}

// Parse WKT (POINT only)
function parseWKT(wkt) {
  let match = /POINT\s*\(\s*([0-9.\-]+)\s+([0-9.\-]+)\s*\)/i.exec(wkt);
  if (match) return [parseFloat(match[1]), parseFloat(match[2])];

  match = /POLYGON\s*\(\(([\d.,\s\-]+)\)\)/i.exec(wkt);
  if (match) {
    const coords = match[1].split(',')[0].trim().split(' ');
    return [parseFloat(coords[0]), parseFloat(coords[1])];
  }

  return null;
}

// Render features
function renderFeatures(features) {
  const container = document.getElementById('tips-list');
  container.innerHTML = '';

  // Clear old markers
  map.markers.forEach(m => m.remove());
  map.markers = [];

  const grouped = groupBy(features, f => f.type);

  for (const type in grouped) {
    const heading = document.createElement('div');
    heading.className = 'type-heading';
    heading.textContent = type.toUpperCase();
    container.appendChild(heading);

    const ul = document.createElement('ul');
    grouped[type].forEach(f => {
      const li = document.createElement('li');
      li.textContent = f.label;
      li.dataset.lat = f.coords[1];
      li.dataset.lon = f.coords[0];
      li.addEventListener('click', () => {
        map.flyTo({center:f.coords, zoom:15});
      });
      ul.appendChild(li);

      const marker = new mapboxgl.Marker({color:getMarkerColor(f.type)})
        .setLngLat(f.coords)
        .setPopup(new mapboxgl.Popup({offset:25}).setText(f.label))
        .addTo(map);
      map.markers.push(marker);
    });
    container.appendChild(ul);
  }
}

// Group by function
function groupBy(array, keyFn) {
  return array.reduce((acc, item) => {
    const key = keyFn(item);
    if (!acc[key]) acc[key] = [];
    acc[key].push(item);
    return acc;
  }, {});
}

// Marker colors
function getMarkerColor(type){
  switch(type){
    case 'hotel': return 'purple';
    case 'museum': return 'orange';
    case 'sports': return 'red';
    case 'restaurant': return 'green';
    default: return 'blue';
  }
}

// Language placeholder
function showLang(lang){
  currentLang = lang;
  console.log("Language switched to:", lang);
}

// Start
loadRdf();
</script>

</body>
</html>
